<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.co.internous.team2506.model.mapper.TblPurchaseHistoryMapper">

	<insert id="insert" useGeneratedKeys="true">
	INSERT
	 INTO 
	  tbl_purchase_history(user_id,product_id,product_count,price, destination_id)
	
	SELECT
	  #{userId},product_id,product_count,price,#{destinationId}
	 FROM 
	  mst_product
	 JOIN 
	  tbl_cart AS C
	 ON 
	  mst_product.id = C.product_id
	  WHERE C.user_id = #{userId}
	
	</insert>
	
	<select id="findByUserId" resultType="jp.co.internous.team2506.model.domain.dto.PurchaseHistoryDto">
    SELECT 
	  history.purchased_at AS purchased_at,
	  history.product_count AS product_count,
	  product.product_name AS product_name,
	  history.price AS price,
	  dest.family_name AS family_name,
	  dest.first_name AS first_name,
	  dest.address AS address
     FROM tbl_purchase_history AS history
     JOIN
      mst_product AS product
     ON
      history.product_id = product.id
     JOIN
      mst_destination AS dest
     ON
      history.destination_id = dest.id
      WHERE
      history.user_id = #{userId} AND history.status = 1
     ORDER BY
      purchased_at DESC;
	</select>
	
</mapper>